<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>The quick coding way to model a steady state solution • RTTshiny</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="The quick coding way to model a steady state solution">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">RTTshiny</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/RTT_Planner_exercise.html">Exercise</a></li>
    <li><a class="dropdown-item" href="../articles/steady_state.html">The quick coding way to model a steady state solution</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>The quick coding way to model a steady state solution</h1>
            
      

      <div class="d-none name"><code>steady_state.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="purpose">Purpose<a class="anchor" aria-label="anchor" href="#purpose"></a>
</h2>
<p>The purpose of this article is to support users of the <a href="https://connect.strategyunitwm.nhs.uk/rtt_compartmental_modelling/" class="external-link">RTT
Planner</a> app that are not currently able to achieve what they want to
from the Steady State section, because the data within the app are only
configured to revolve around Trusts (eg, it isn’t possible to aggregate
within the tool). Examples of what you might want to do, but can’t
currently achieve within the app, are:</p>
<ol style="list-style-type: decimal">
<li>You work for an Integrated Care Board and are interested in
modelling for your registered population</li>
<li>You work at a trust but want to model at sub-specialty level</li>
<li>You work at NHS England and want to get an overall regional
picture</li>
</ol>
<p>Finally, this article shows how to apply the functionality to
multiple geographies and specialties together (eg, a batch application).
This uses the <a href="https://purrr.tidyverse.org/" class="external-link">purrr</a> package.</p>
</div>
<div class="section level2">
<h2 id="caveats">Caveats<a class="anchor" aria-label="anchor" href="#caveats"></a>
</h2>
<p>This article shows how to use the code underpinning the RTT Planner
tool. The functions used here were not developed to be used within code,
as this article is demonstrating. The reason for putting this article
together is to address a lot of questions we have received since
publishing the tool, but will not be able to address within the tool
within a reasonable timescale.</p>
<p>Having said this, there is no reason that the functions described and
used here will break in the near future, so, for the foreseeable future,
it should be ok to replicate the code below.</p>
</div>
<div class="section level2">
<h2 id="objective">Objective<a class="anchor" aria-label="anchor" href="#objective"></a>
</h2>
<p>The aim of this article is to show how to produce the table in the
steady state tab in the RTT Planner tool, for 2 different specialties
(ear, nose and throat, and oral surgery) in one geography (an ICB
commissioning area) and one demand scenario, using code. Readers should
then be able to either change the inputs shown here, or upload their own
data into R and apply the same principles, to obtain results for
configurations that they are interested in.</p>
</div>
<div class="section level2">
<h2 id="libraries">Libraries<a class="anchor" aria-label="anchor" href="#libraries"></a>
</h2>
<p>Here are the libraries you will need to import to replicate the code
in this article. Two of the libraries are from GitHub (not CRAN) and so
you may need to uncomment the commented lines out to install them before
being able to write <code><a href="https://nhs-bnssg-analytics.github.io/NHSRtt/" class="external-link">library(NHSRtt)</a></code> (for example).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("devtools")</span></span>
<span><span class="co"># devtools::install_github("nhs-bnssg-analytics/NHSRtt")</span></span>
<span><span class="co"># devtools::install_github("nhs-bnssg-analytics/RTT_compartmental_modelling")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nhs-bnssg-analytics.github.io/NHSRtt/" class="external-link">NHSRtt</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nhs-bnssg-analytics.github.io/RTT_compartmental_modelling/">RTTshiny</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="obtaining-the-data">Obtaining the data<a class="anchor" aria-label="anchor" href="#obtaining-the-data"></a>
</h2>
<p>This section shows how to import public data. At the end of this
section, the data will be in a shape to pass into the modelling. If the
user is considering applying this article to local data, take note of
what the data look like at the end of this section.</p>
<div class="section level3">
<h3 id="setting-up-the-scenario">Setting up the scenario<a class="anchor" aria-label="anchor" href="#setting-up-the-scenario"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">calibration_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2024-08-01"</span><span class="op">)</span> <span class="co"># amend as necessary</span></span>
<span><span class="va">calibration_end</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2025-09-30"</span><span class="op">)</span> <span class="co"># amend as necessary</span></span>
<span><span class="va">prediction_start</span> <span class="op">&lt;-</span> <span class="va">calibration_end</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="va">prediction_end</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2029-03-31"</span><span class="op">)</span> <span class="co"># amend as necessary</span></span>
<span><span class="va">commissioner_code</span> <span class="op">&lt;-</span> <span class="st">"15E"</span> <span class="co"># this is used for downloading public data</span></span>
<span><span class="va">max_months_waited</span> <span class="op">&lt;-</span> <span class="fl">12</span> <span class="co"># I am only interested in waiting time compartments up to 12 months (everything above this gets aggregated into one compartment)</span></span>
<span><span class="va">target_percentile</span> <span class="op">&lt;-</span> <span class="fl">0.92</span> <span class="co"># eg, 92%</span></span>
<span><span class="va">target_week</span> <span class="op">&lt;-</span> <span class="fl">18</span> <span class="co"># eg, 18 week performance target</span></span>
<span><span class="va">referral_scenario</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  referrals_scenario <span class="op">=</span> <span class="st">"Medium_referrals"</span>,</span>
<span>  referral_change <span class="op">=</span> <span class="fl">1</span> <span class="co"># these are the annual percentage increase in demand</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">spec_codes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"C_120"</span>, <span class="co"># ear, nose, throat</span></span>
<span>  <span class="st">"C_140"</span> <span class="co"># oral surgery</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">spec_lkp</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  specialty <span class="op">=</span> <span class="va">spec_codes</span>,</span>
<span>  specialty_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Ear Nose and Throat"</span>, <span class="st">"Oral Surgery"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># need a lookup table from month to id</span></span>
<span><span class="va">period_lkp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span></span>
<span>    from <span class="op">=</span> <span class="va">calibration_start</span>,</span>
<span>    to <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html" class="external-link">floor_date</a></span><span class="op">(</span><span class="va">prediction_end</span>, unit <span class="op">=</span> <span class="st">"months"</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"months"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>period_id <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate the number of months for projection period</span></span>
<span><span class="va">forecast_months</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/interval.html" class="external-link">interval</a></span><span class="op">(</span></span>
<span>  <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html" class="external-link">floor_date</a></span><span class="op">(</span></span>
<span>    <span class="va">calibration_end</span>,</span>
<span>    unit <span class="op">=</span> <span class="st">"months"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html" class="external-link">%m+%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html" class="external-link">months</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="va">prediction_end</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html" class="external-link">months</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fl">1</span> <span class="co"># the plus 1 makes is inclusive of the final month</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="downloading-the-data">Downloading the data<a class="anchor" aria-label="anchor" href="#downloading-the-data"></a>
</h3>
<p>Here the public data are downloaded and processed into the shape
required later.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">monthly_rtt</span> <span class="op">&lt;-</span> <span class="fu">NHSRtt</span><span class="fu">::</span><span class="fu"><a href="https://nhs-bnssg-analytics.github.io/NHSRtt/reference/get_rtt_data.html" class="external-link">get_rtt_data</a></span><span class="op">(</span></span>
<span>  date_start <span class="op">=</span> <span class="va">calibration_start</span>,</span>
<span>  date_end <span class="op">=</span> <span class="va">calibration_end</span>,</span>
<span>  commissioner_org_codes <span class="op">=</span> <span class="va">commissioner_code</span>,</span>
<span>  specialty_codes <span class="op">=</span> <span class="va">spec_codes</span>,</span>
<span>  show_progress <span class="op">=</span> <span class="cn">FALSE</span> <span class="co"># can change this to TRUE to see progress</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">processed_rtt</span> <span class="op">&lt;-</span> <span class="va">monthly_rtt</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    months_waited_id <span class="op">=</span> <span class="fu">NHSRtt</span><span class="fu">::</span><span class="fu"><a href="https://nhs-bnssg-analytics.github.io/NHSRtt/reference/convert_months_waited_to_id.html" class="external-link">convert_months_waited_to_id</a></span><span class="op">(</span></span>
<span>      <span class="va">months_waited</span>,</span>
<span>      max_months_waited <span class="op">=</span> <span class="va">max_months_waited</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">period_lkp</span>, by <span class="op">=</span> <span class="st">"period"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">spec_lkp</span>, by <span class="op">=</span> <span class="st">"specialty"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"specialty"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>specialty <span class="op">=</span> <span class="st">"specialty_name"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,</span>
<span>    .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"specialty"</span>, <span class="st">"period_id"</span>, <span class="st">"months_waited_id"</span>, <span class="st">"type"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># the functions below need "trust" and "specialty" fields to work (when running this for a batch, these can be replaced with real values)</span></span>
<span>    trust <span class="op">=</span> <span class="va">commissioner_code</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Here is what the processed data look like before ‘nesting’ it</p>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 756 × 6</span></span></span>
<span><span class="co">#&gt;    specialty    period_id months_waited_id type       value trust</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Oral Surgery        14                0 Incomplete <span style="text-decoration: underline;">1</span>707. 15E  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Oral Surgery        14                1 Incomplete <span style="text-decoration: underline;">1</span>699. 15E  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Oral Surgery        14                2 Incomplete <span style="text-decoration: underline;">1</span>805. 15E  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Oral Surgery        14                3 Incomplete <span style="text-decoration: underline;">1</span>636. 15E  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Oral Surgery        14                4 Incomplete <span style="text-decoration: underline;">1</span>527. 15E  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Oral Surgery        14                5 Incomplete <span style="text-decoration: underline;">1</span>253  15E  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Oral Surgery        14                6 Incomplete  878. 15E  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Oral Surgery        14                7 Incomplete  560. 15E  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Oral Surgery        14                8 Incomplete  347. 15E  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Oral Surgery        14                9 Incomplete  267. 15E  </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 746 more rows</span></span></span></code></pre>
</div>
<div class="section level3">
<h3 id="target-renege-rates">Target renege rates<a class="anchor" aria-label="anchor" href="#target-renege-rates"></a>
</h3>
<p>As well as a target performance, The steady-state calculation needs a
target renege rate - the proportion of departures that are reneges.
Here, it is calculated as the median value from the calibration period
(by specialty). This can be a user input, so see the table below for
what the resulting input table needs to look like.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># calculate historical renege rates</span></span>
<span><span class="va">renege_target</span> <span class="op">&lt;-</span> <span class="va">processed_rtt</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># calibrate_parameters is an internal function that does a load of data processing before calibrating the parameters;</span></span>
<span>  <span class="co"># in this case it is used to create a big table of monthly data so we can obtain the monthly reneges;</span></span>
<span>  <span class="co"># here it creates a table with 2 records (one for each specialty) with columns containing "nested tables" for treatments, referrals and incompletes for the calibration period, and then it calculates the model parameters based on those columns</span></span>
<span>  <span class="fu">RTTshiny</span><span class="fu">:::</span><span class="fu">calibrate_parameters</span><span class="op">(</span></span>
<span>    max_months_waited <span class="op">=</span> <span class="fl">12</span>,</span>
<span>    redistribute_m0_reneges <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    referrals_uplift <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    full_breakdown <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    allow_negative_params <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="st">"trust"</span>, <span class="st">"specialty"</span>, <span class="st">"params"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="st">"params"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    reneges <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="co"># when modelling occurs, referrals are uplifted where reneges are negative in the first month of waiting to accommodate underreporting of referrals - so reneges are floored to 0 when they are negative</span></span>
<span>      <span class="va">reneges</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">months_waited_id</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>      .default <span class="op">=</span> <span class="va">reneges</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># calculate the monthly proportion of departures that are reneges</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    renege_proportion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">reneges</span><span class="op">)</span> <span class="op">/</span></span>
<span>      <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">reneges</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">treatments</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"trust"</span>, <span class="st">"specialty"</span>, <span class="st">"period_id"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    renege_proportion <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">renege_proportion</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">~</span> <span class="cn">NA_real_</span>,</span>
<span>      .default <span class="op">=</span> <span class="va">renege_proportion</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># calculate the median value</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    renege_proportion <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span></span>
<span>      <span class="va">renege_proportion</span>,</span>
<span>      na.rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span>,</span>
<span>    .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"trust"</span>, <span class="st">"specialty"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 3</span></span></span>
<span><span class="co">#&gt;   trust specialty           renege_proportion</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 15E   Ear Nose and Throat             0.233</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 15E   Oral Surgery                    0.108</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="modelling-steady-state">Modelling steady state<a class="anchor" aria-label="anchor" href="#modelling-steady-state"></a>
</h2>
<p>We are ready to model the steady-state table. This has 3 main
parts:</p>
<ol style="list-style-type: decimal">
<li>The current situation</li>
<li>The steady-state scenario</li>
<li>The do-nothing scenario</li>
</ol>
<div class="section level3">
<h3 id="current-situation">Current situation<a class="anchor" aria-label="anchor" href="#current-situation"></a>
</h3>
<p>The <code>append_current_status()</code> function creates the current
situation part of the table.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># this normally gives a warning about negative reneges</span></span>
<span><span class="va">current</span> <span class="op">&lt;-</span> <span class="va">processed_rtt</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">period_lkp</span>, by <span class="op">=</span> <span class="st">"period_id"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">RTTshiny</span><span class="fu">:::</span><span class="fu">append_current_status</span><span class="op">(</span></span>
<span>    max_months_waited <span class="op">=</span> <span class="va">max_months_waited</span>,</span>
<span>    percentile <span class="op">=</span> <span class="va">target_percentile</span>,</span>
<span>    percentile_month <span class="op">=</span> <span class="fu">RTTshiny</span><span class="fu">:::</span><span class="fu">convert_weeks_to_months</span><span class="op">(</span><span class="va">target_week</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># add the referrals scenarios</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/cross_join.html" class="external-link">cross_join</a></span><span class="op">(</span><span class="va">referral_scenario</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: There were 2 warnings in `mutate()`.</span></span>
<span><span class="co">#&gt; The first warning was:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> In argument: `params = purrr::pmap(...)`.</span></span>
<span><span class="co">#&gt; Caused by warning in `NHSRtt::calibrate_capacity_renege_params()`:</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> negative renege parameters present, investigate raw data</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Run `dplyr::last_dplyr_warnings()` to see the 1 remaining warning.</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 12</span></span></span>
<span><span class="co">#&gt;   trust specialty       referrals_t1 capacity_t1 reneges_t0  load incompletes_t0</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 15E   Ear Nose and T…        <span style="text-decoration: underline;">2</span>055.       <span style="text-decoration: underline;">1</span>756.       703.  0.84          <span style="text-decoration: underline;">14</span>117</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 15E   Oral Surgery           <span style="text-decoration: underline;">1</span>907.       <span style="text-decoration: underline;">1</span>820.       952.  0.69          <span style="text-decoration: underline;">12</span>045</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 5 more variables: params &lt;list&gt;, pressure &lt;dbl&gt;, referrals_scenario &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   referral_change &lt;dbl&gt;, id &lt;int&gt;</span></span></span></code></pre>
</div>
<div class="section level3">
<h3 id="steady-state">Steady-state<a class="anchor" aria-label="anchor" href="#steady-state"></a>
</h3>
<p>Steady state is modelled before the “do-nothing” scenario, because
the future demand is an output of the <code>append_steady_state()</code>
function. This is an input to the <code>append_counterfactual()</code>
function used to model “do-nothing”.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A constraint to the steady state modelling is how the treatment is distributed across the waiting list.</span></span>
<span><span class="co"># The model wants to minimise the difference between the resulting solution and some provided distribution of treatment.</span></span>
<span><span class="co"># Here, we calculate the median distribution seen in the calibration period</span></span>
<span><span class="va">s_given</span> <span class="op">&lt;-</span> <span class="va">processed_rtt</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">period_lkp</span>, by <span class="op">=</span> <span class="st">"period_id"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">RTTshiny</span><span class="fu">:::</span><span class="fu">calculate_s_given</span><span class="op">(</span></span>
<span>    max_months_waited <span class="op">=</span> <span class="va">max_months_waited</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"median"</span> <span class="co"># can also be "mean" or "latest"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">optimised_projections</span> <span class="op">&lt;-</span> <span class="va">current</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># add historic treatment distributions</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">s_given</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"trust"</span>, <span class="st">"specialty"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># add historic renege rates by specialty</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">renege_target</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="st">"trust"</span>, <span class="st">"specialty"</span>, <span class="st">"renege_proportion"</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"trust"</span>, <span class="st">"specialty"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># calculate steady state demand</span></span>
<span>    referrals_ss <span class="op">=</span> <span class="va">referrals_t1</span> <span class="op">+</span></span>
<span>      <span class="op">(</span><span class="op">(</span><span class="va">referrals_t1</span> <span class="op">*</span> <span class="va">referral_change</span> <span class="op">/</span> <span class="fl">100</span><span class="op">)</span> <span class="op">*</span></span>
<span>        <span class="va">forecast_months</span> <span class="op">/</span></span>
<span>        <span class="fl">12</span><span class="op">)</span>,</span>
<span>    target <span class="op">=</span> <span class="va">renege_proportion</span>,</span>
<span>    <span class="co"># here we apply the append_steady_state function one row at a time</span></span>
<span>    ss_calcs <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pmap</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        ref_ss <span class="op">=</span> <span class="va">referrals_ss</span>,</span>
<span>        targ <span class="op">=</span> <span class="va">target</span>,</span>
<span>        par <span class="op">=</span> <span class="va">params</span>,</span>
<span>        s <span class="op">=</span> <span class="va">s_given</span>,</span>
<span>        id <span class="op">=</span> <span class="va">id</span></span>
<span>      <span class="op">)</span>,</span>
<span>      \<span class="op">(</span><span class="va">ref_ss</span>, <span class="va">targ</span>, <span class="va">par</span>, <span class="va">s</span>, <span class="va">id</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># here is where the steady state calculation occurs</span></span>
<span>        <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">RTTshiny</span><span class="fu">:::</span><span class="fu">append_steady_state</span><span class="op">(</span></span>
<span>          referrals <span class="op">=</span> <span class="va">ref_ss</span>,</span>
<span>          target <span class="op">=</span> <span class="va">targ</span>,</span>
<span>          renege_params <span class="op">=</span> <span class="va">par</span><span class="op">$</span><span class="va">renege_param</span>,</span>
<span>          percentile <span class="op">=</span> <span class="va">target_percentile</span>,</span>
<span>          target_time <span class="op">=</span> <span class="va">target_week</span>,</span>
<span>          s_given <span class="op">=</span> <span class="va">s</span>,</span>
<span>          method <span class="op">=</span> <span class="st">"lp"</span>,</span>
<span>          tolerance <span class="op">=</span> <span class="fl">0.005</span></span>
<span>        <span class="op">)</span></span>
<span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="st">"ss_calcs"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># This is where activity is calculated from treatment and renege clock stops.</span></span>
<span>    <span class="co"># It uses England-level analysis, by specialty, from 2022 - and applies high-level</span></span>
<span>    <span class="co"># proportions to the clock stop counts to calculate activity (inpatient and outpatient)</span></span>
<span>    activity <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2</a></span><span class="op">(</span></span>
<span>      .x <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">specialty</span>,</span>
<span>      .y <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">capacity_ss</span> <span class="op">+</span> <span class="va">.data</span><span class="op">$</span><span class="va">reneges_ss</span>,</span>
<span>      \<span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">activity_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span></span>
<span>          <span class="va">y</span>,</span>
<span>          nm <span class="op">=</span> <span class="va">x</span></span>
<span>        <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>          <span class="fu">RTTshiny</span><span class="fu">::</span><span class="fu"><a href="../reference/convert_clock_stops_to_activity.html">convert_clock_stops_to_activity</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>          <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html" class="external-link">pluck</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>        <span class="va">op_to_first_calc</span> <span class="op">&lt;-</span> <span class="va">activity_summary</span><span class="op">$</span><span class="va">avg_op_first_activity_per_pathway_op_only</span> <span class="op">+</span></span>
<span>          <span class="va">activity_summary</span><span class="op">$</span><span class="va">avg_op_first_activity_per_pathway_mixed</span></span>
<span></span>
<span>        <span class="va">op_follow_up_calc</span> <span class="op">&lt;-</span> <span class="va">activity_summary</span><span class="op">$</span><span class="va">avg_op_flup_activity_per_pathway_op_only</span> <span class="op">+</span></span>
<span>          <span class="va">activity_summary</span><span class="op">$</span><span class="va">avg_op_flup_activity_per_pathway_mixed</span></span>
<span></span>
<span>        <span class="va">activity_out</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>          op_to_first <span class="op">=</span> <span class="va">op_to_first_calc</span>,</span>
<span>          op_follow_up <span class="op">=</span> <span class="va">op_follow_up_calc</span>,</span>
<span>          ip_day <span class="op">=</span> <span class="va">activity_summary</span><span class="op">$</span><span class="va">ip_daycase_count</span>,</span>
<span>          ip_non_day <span class="op">=</span> <span class="va">activity_summary</span><span class="op">$</span><span class="va">ip_non_daycase_count</span></span>
<span>        <span class="op">)</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">activity_out</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="st">"activity"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># calculate the ratio of the current waiting list size</span></span>
<span>    <span class="co"># to the steady state waiting list size</span></span>
<span>    current_vs_ss_wl_ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span></span>
<span>      <span class="va">incompletes_t0</span> <span class="op">/</span> <span class="va">incompletes_ss</span>,</span>
<span>      <span class="fl">2</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># calculate the monthly reduction in waiting list size to </span></span>
<span>    <span class="co"># achieve the required waiting list size</span></span>
<span>    monthly_reduction <span class="op">=</span> <span class="op">(</span><span class="va">incompletes_t0</span> <span class="op">-</span></span>
<span>      <span class="va">incompletes_ss</span><span class="op">)</span> <span class="op">/</span></span>
<span>      <span class="va">forecast_months</span>,</span>
<span>    referrals_scenario <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span></span>
<span>      <span class="st">"_referrals"</span>,</span>
<span>      <span class="st">""</span>,</span>
<span>      <span class="va">referrals_scenario</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="do-nothing">Do-nothing<a class="anchor" aria-label="anchor" href="#do-nothing"></a>
</h3>
<p>This is where the counterfactual is calculated.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># First, the waiting list size and distribution at the end of the calibration period</span></span>
<span><span class="co"># needs to be calculated</span></span>
<span><span class="va">wl_t0</span> <span class="op">&lt;-</span> <span class="va">processed_rtt</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">period_lkp</span>, by <span class="op">=</span> <span class="st">"period_id"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"Incomplete"</span>,</span>
<span>    <span class="va">period</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">period</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"period"</span>, <span class="st">"period_id"</span>, <span class="st">"type"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>incompletes <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">nest</a></span><span class="op">(</span>wl_t0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"months_waited_id"</span>, <span class="st">"incompletes"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">wl_t0</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 3</span></span></span>
<span><span class="co">#&gt;   specialty           trust wl_t0            </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Oral Surgery        15E   <span style="color: #949494;">&lt;tibble [13 × 2]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> Ear Nose and Throat 15E   <span style="color: #949494;">&lt;tibble [13 × 2]&gt;</span></span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optimised_projections</span> <span class="op">&lt;-</span> <span class="va">optimised_projections</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">wl_t0</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"trust"</span>, <span class="st">"specialty"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    id <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    counterfactual <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pmap</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        cap <span class="op">=</span> <span class="va">capacity_t1</span>, <span class="co"># capacity is constant (current value) for projection period</span></span>
<span>        ref_start <span class="op">=</span> <span class="va">referrals_t1</span>, <span class="co"># demand begins with current demand</span></span>
<span>        ref_end <span class="op">=</span> <span class="va">referrals_ss</span>, <span class="co"># demand is the steady state demand</span></span>
<span>        inc <span class="op">=</span> <span class="va">wl_t0</span>,</span>
<span>        par <span class="op">=</span> <span class="va">params</span>,</span>
<span>        t <span class="op">=</span> <span class="va">trust</span>,</span>
<span>        sp <span class="op">=</span> <span class="va">specialty</span>,</span>
<span>        id <span class="op">=</span> <span class="va">id</span></span>
<span>      <span class="op">)</span>,</span>
<span>      \<span class="op">(</span><span class="va">cap</span>, <span class="va">ref_start</span>, <span class="va">ref_end</span>, <span class="va">inc</span>, <span class="va">par</span>, <span class="va">t</span>, <span class="va">sp</span>, <span class="va">id</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">counterf</span> <span class="op">&lt;-</span> <span class="fu">RTTshiny</span><span class="fu">:::</span><span class="fu">append_counterfactual</span><span class="op">(</span></span>
<span>          capacity <span class="op">=</span> <span class="va">cap</span>,</span>
<span>          referrals_start <span class="op">=</span> <span class="va">ref_start</span>,</span>
<span>          referrals_end <span class="op">=</span> <span class="va">ref_end</span>,</span>
<span>          incompletes_t0 <span class="op">=</span> <span class="va">inc</span>,</span>
<span>          renege_capacity_params <span class="op">=</span> <span class="va">par</span>,</span>
<span>          forecast_months <span class="op">=</span> <span class="va">forecast_months</span>,</span>
<span>          target_week <span class="op">=</span> <span class="va">target_week</span></span>
<span>        <span class="op">)</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">counterf</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="st">"counterfactual"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"params"</span>,</span>
<span>      <span class="st">"referral_change"</span>,</span>
<span>      <span class="st">"id"</span>,</span>
<span>      <span class="st">"renege_proportion"</span>,</span>
<span>      <span class="st">"target"</span>,</span>
<span>      <span class="st">"wl_ss"</span>,</span>
<span>      <span class="st">"wl_t0"</span>,</span>
<span>      <span class="st">"s_given"</span>,</span>
<span>      <span class="st">"id"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    referrals_counterf <span class="op">=</span> <span class="va">referrals_ss</span>, <span class="co"># eg, demand is the steady state demand</span></span>
<span>    capacity_counterf <span class="op">=</span> <span class="va">capacity_t1</span> <span class="co"># eg, capacity stays the same as current</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>        <span class="st">"referrals_counterf"</span>,</span>
<span>        <span class="st">"capacity_counterf"</span>,</span>
<span>        <span class="st">"reneges_counterf"</span>,</span>
<span>        <span class="st">"incompletes_counterf"</span>,</span>
<span>        <span class="st">"perf_counterf"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    .before <span class="op">=</span> <span class="st">"referrals_ss"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span></span>
<span>    <span class="st">"referrals_scenario"</span>,</span>
<span>    .after <span class="op">=</span> <span class="st">"specialty"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="results">Results<a class="anchor" aria-label="anchor" href="#results"></a>
</h2>
<p>This is what the resulting table looks like. The column headers are
still in raw form and there has been no rounding to any of the data.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">optimised_projections</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="1%">
<col width="5%">
<col width="5%">
<col width="3%">
<col width="3%">
<col width="3%">
<col width="1%">
<col width="4%">
<col width="2%">
<col width="5%">
<col width="5%">
<col width="5%">
<col width="6%">
<col width="4%">
<col width="3%">
<col width="3%">
<col width="3%">
<col width="4%">
<col width="3%">
<col width="3%">
<col width="2%">
<col width="3%">
<col width="6%">
<col width="5%">
</colgroup>
<thead><tr class="header">
<th align="left">trust</th>
<th align="left">specialty</th>
<th align="left">referrals_scenario</th>
<th align="right">referrals_t1</th>
<th align="right">capacity_t1</th>
<th align="right">reneges_t0</th>
<th align="right">load</th>
<th align="right">incompletes_t0</th>
<th align="right">pressure</th>
<th align="right">referrals_counterf</th>
<th align="right">capacity_counterf</th>
<th align="right">reneges_counterf</th>
<th align="right">incompletes_counterf</th>
<th align="right">perf_counterf</th>
<th align="right">referrals_ss</th>
<th align="right">capacity_ss</th>
<th align="right">reneges_ss</th>
<th align="right">incompletes_ss</th>
<th align="right">op_to_first</th>
<th align="right">op_follow_up</th>
<th align="right">ip_day</th>
<th align="right">ip_non_day</th>
<th align="right">current_vs_ss_wl_ratio</th>
<th align="right">monthly_reduction</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">15E</td>
<td align="left">Ear Nose and Throat</td>
<td align="left">Medium</td>
<td align="right">2055.444</td>
<td align="right">1755.923</td>
<td align="right">702.766</td>
<td align="right">0.84</td>
<td align="right">14117</td>
<td align="right">2.953936</td>
<td align="right">2127.385</td>
<td align="right">1755.923</td>
<td align="right">368.8032</td>
<td align="right">10636.897</td>
<td align="right">0.4630164</td>
<td align="right">2127.385</td>
<td align="right">1951.838</td>
<td align="right">175.5470</td>
<td align="right">5578.415</td>
<td align="right">2260.857</td>
<td align="right">2247.071</td>
<td align="right">245.5990</td>
<td align="right">88.54930</td>
<td align="right">2.53</td>
<td align="right">203.2996</td>
</tr>
<tr class="even">
<td align="left">15E</td>
<td align="left">Oral Surgery</td>
<td align="left">Medium</td>
<td align="right">1906.705</td>
<td align="right">1819.923</td>
<td align="right">952.246</td>
<td align="right">0.69</td>
<td align="right">12045</td>
<td align="right">1.943767</td>
<td align="right">1973.440</td>
<td align="right">1819.923</td>
<td align="right">166.4405</td>
<td align="right">6098.088</td>
<td align="right">0.7035103</td>
<td align="right">1973.440</td>
<td align="right">1898.873</td>
<td align="right">74.5673</td>
<td align="right">6205.471</td>
<td align="right">1441.243</td>
<td align="right">1542.756</td>
<td align="right">501.7495</td>
<td align="right">32.02656</td>
<td align="right">1.94</td>
<td align="right">139.0364</td>
</tr>
</tbody>
</table>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Seb Fox, Simon Wellesley-Miller, Nick Cooper, Richard Wood.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
